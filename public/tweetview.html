<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tweet - Tweetapus</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 600px;
        margin: 0 auto;
        color: #1a1a1a;
        font-size: 16px;
        padding: 0 24px;
        background: #fafafa;
        line-height: 1.4;
      }

      .header {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 16px 0;
        margin: 0 -24px 24px -24px;
        padding-left: 24px;
        padding-right: 24px;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .header-content {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .back-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        color: #6366f1;
        font-size: 18px;
        transition: background-color 0.2s;
      }

      .back-btn:hover {
        background: #f3f4f6;
      }

      .header-title {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
      }

      .thread-container {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        margin-bottom: 24px;
        overflow: hidden;
      }

      .thread-post {
        padding: 16px 20px;
        border-bottom: 1px solid #f3f4f6;
        position: relative;
      }

      .thread-post:last-child {
        border-bottom: none;
      }

      .thread-post.current-post {
        background: #f8fafc;
        border-left: 3px solid #6366f1;
      }

      .thread-line {
        position: absolute;
        left: 35px;
        top: 60px;
        bottom: -1px;
        width: 2px;
        background: #e5e7eb;
      }

      .thread-post:last-child .thread-line {
        display: none;
      }

      .post-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }

      .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #6366f1;
        font-size: 16px;
        flex-shrink: 0;
      }

      .post-author-info {
        flex: 1;
      }

      .post-author {
        font-weight: 600;
        color: #1a1a1a;
        margin: 0;
      }

      .post-meta {
        color: #6b7280;
        font-size: 14px;
        margin: 0;
      }

      .post-content {
        margin-left: 52px;
        margin-bottom: 16px;
        font-size: 16px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .post-content.large {
        font-size: 18px;
        line-height: 1.4;
      }

      .post-actions {
        margin-left: 52px;
        display: flex;
        gap: 24px;
        font-size: 14px;
        color: #6b7280;
      }

      .post-action {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s;
        background: none;
        border: none;
        color: inherit;
        font-size: inherit;
      }

      .post-action:hover {
        background: #f3f4f6;
        color: #6366f1;
      }

      .post-action.reply:hover {
        background: #dbeafe;
        color: #2563eb;
      }

      .post-action.like:hover {
        background: #fecaca;
        color: #dc2626;
      }

      .post-action.retweet:hover {
        background: #dcfce7;
        color: #16a34a;
      }

      .post-action .icon {
        width: 16px;
        height: 16px;
      }

      .replies-section {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        margin-bottom: 24px;
      }

      .replies-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        font-weight: 600;
        color: #1a1a1a;
      }

      .reply-composer {
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
      }

      .composer-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }

      .reply-textarea {
        width: 100%;
        min-height: 80px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 12px;
        font-size: 16px;
        font-family: inherit;
        resize: vertical;
        margin-bottom: 12px;
      }

      .reply-textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .composer-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .char-count {
        color: #6b7280;
        font-size: 14px;
      }

      .char-count.over-limit {
        color: #dc2626;
      }

      .reply-btn {
        background: #6366f1;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 8px 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .reply-btn:hover:not(:disabled) {
        background: #5855eb;
      }

      .reply-btn:disabled {
        background: #d1d5db;
        cursor: not-allowed;
      }

      .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: #6b7280;
      }

      .loading {
        text-align: center;
        padding: 24px;
        color: #6b7280;
      }

      .error {
        background: #fef2f2;
        color: #dc2626;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #fecaca;
        margin-bottom: 24px;
      }

      .status {
        margin-top: 12px;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        display: none;
      }

      .status.error {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
      }

      .status.success {
        background: #f0fdf4;
        color: #16a34a;
        border: 1px solid #bbf7d0;
      }

      @media (max-width: 768px) {
        body {
          padding: 0 16px;
        }

        .header {
          margin: 0 -16px 24px -16px;
          padding-left: 16px;
          padding-right: 16px;
        }

        .post-content {
          margin-left: 0;
        }

        .post-actions {
          margin-left: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <button class="back-btn" onclick="goBack()">←</button>
        <h1 class="header-title">Tweet</h1>
      </div>
    </div>

    <div id="errorContainer"></div>
    <div id="loadingContainer" class="loading">Loading tweet...</div>

    <div id="tweetContainer" style="display: none">
      <div class="thread-container" id="threadContainer"></div>

      <div class="replies-section">
        <div class="replies-header">
          <span id="repliesCount">0 replies</span>
        </div>

        <div class="reply-composer" id="replyComposer" style="display: none">
          <div class="composer-header">
            <div class="avatar" id="userAvatar">U</div>
            <div>
              <div class="post-author" id="userName">Your Name</div>
              <div class="post-meta">
                Replying to
                <span id="replyingTo">@username</span>
              </div>
            </div>
          </div>
          <textarea
            class="reply-textarea"
            id="replyText"
            placeholder="Tweet your reply"
            maxlength="400"
          ></textarea>
          <div class="composer-footer">
            <span class="char-count" id="charCount">0 / 400</span>
            <button class="reply-btn" id="sendReply" disabled>Reply</button>
          </div>
          <div class="status" id="replyStatus"></div>
        </div>

        <div id="repliesContainer"></div>
      </div>
    </div>

    <script>
      let currentTweet = null;
      let currentUser = null;
      const authToken = localStorage.getItem("authToken");
      const tweetId = window.location.pathname.split("/").pop();

      if (!tweetId || tweetId === "tweetview.html") {
        window.location.href = "/";
      }

      const loadCurrentUser = async () => {
        if (!authToken) return;

        try {
          const response = await fetch("/api/auth/me", {
            headers: { Authorization: `Bearer ${authToken}` },
          });
          const data = await response.json();

          if (data.user) {
            currentUser = data.user;
            setupReplyComposer();
          }
        } catch (error) {
          console.error("Failed to load user:", error);
        }
      };

      const loadTweet = async () => {
        try {
          const response = await fetch(`/api/tweets/${tweetId}`, {
            headers: authToken ? { Authorization: `Bearer ${authToken}` } : {},
          });
          const data = await response.json();

          if (data.error) {
            showError(data.error);
            return;
          }

          currentTweet = data;
          renderTweet(data);
        } catch (error) {
          showError("Failed to load tweet");
        } finally {
          document.getElementById("loadingContainer").style.display = "none";
        }
      };

      const renderTweet = (data) => {
        const { post, threadPosts, replies } = data;

        renderThread(threadPosts, post.id);
        renderReplies(replies);

        document.getElementById("tweetContainer").style.display = "block";
      };

      const renderThread = (threadPosts, currentPostId) => {
        const container = document.getElementById("threadContainer");

        container.innerHTML = threadPosts
          .map((post, index) => {
            const isCurrentPost = post.id === currentPostId;
            const isLast = index === threadPosts.length - 1;
            const isLiked = post.liked_by_user;
            const heartFill = isLiked ? "red" : "none";
            const heartStroke = isLiked ? "red" : "currentColor";

            return `
            <div class="thread-post ${isCurrentPost ? "current-post" : ""}">
              ${!isLast ? '<div class="thread-line"></div>' : ""}
              <div class="post-header">
                <div class="avatar">${(post.display_name || post.username)
                  .charAt(0)
                  .toUpperCase()}</div>
                <div class="post-author-info">
                  <p class="post-author">${escapeHtml(
                    post.display_name || post.username
                  )}</p>
                  <p class="post-meta">@${escapeHtml(
                    post.username
                  )} · ${formatDate(post.created_at)}</p>
                </div>
              </div>
              <div class="post-content ${
                isCurrentPost ? "large" : ""
              }">${escapeHtml(post.content)}</div>
              <div class="post-actions">
                <button class="post-action reply" onclick="startReply('${
                  post.id
                }', '${escapeHtml(post.username)}')">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                  </svg>
                  <span>${post.reply_count || 0}</span>
                </button>
                <button class="post-action retweet" onclick="toggleRetweet('${post.id}', this)" data-retweeted="${post.retweeted_by_user || false}" data-tweet-id="${post.id}">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="${post.retweeted_by_user ? '#00BA7C' : 'currentColor'}" stroke-width="2">
                    <path d="M17 1l4 4-4 4"/>
                    <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                    <path d="M7 23l-4-4 4-4"/>
                    <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                  </svg>
                  <span class="retweet-count">${post.retweet_count || 0}</span>
                </button>
                <button class="post-action like" onclick="toggleLike('${
                  post.id
                }', this)" data-liked="${isLiked}" data-tweet-id="${post.id}">
                  <svg class="icon" viewBox="0 0 24 24" fill="${heartFill}" stroke="${heartStroke}" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                  </svg>
                  <span class="like-count">${post.like_count || 0}</span>
                </button>
              </div>
            </div>
          `;
          })
          .join("");
      };

      const renderReplies = (replies) => {
        const container = document.getElementById("repliesContainer");
        const countEl = document.getElementById("repliesCount");

        countEl.textContent = `${replies.length} ${
          replies.length === 1 ? "reply" : "replies"
        }`;

        if (!replies || replies.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <h3>No replies yet</h3>
              <p>Be the first to reply!</p>
            </div>
          `;
          return;
        }

        container.innerHTML = replies
          .map((reply) => {
            const isLiked = reply.liked_by_user;
            const heartFill = isLiked ? "red" : "none";
            const heartStroke = isLiked ? "red" : "currentColor";

            return `
            <div class="thread-post">
              <div class="post-header">
                <div class="avatar">${(reply.display_name || reply.username)
                  .charAt(0)
                  .toUpperCase()}</div>
                <div class="post-author-info">
                  <p class="post-author">${escapeHtml(
                    reply.display_name || reply.username
                  )}</p>
                  <p class="post-meta">@${escapeHtml(
                    reply.username
                  )} · ${formatDate(reply.created_at)}</p>
                </div>
              </div>
              <div class="post-content">${escapeHtml(reply.content)}</div>
              <div class="post-actions">
                <button class="post-action reply" onclick="startReply('${
                  reply.id
                }', '${escapeHtml(reply.username)}')">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                  </svg>
                  <span>${reply.reply_count || 0}</span>
                </button>
                <button class="post-action retweet" onclick="toggleRetweet('${reply.id}', this)" data-retweeted="${reply.retweeted_by_user || false}" data-tweet-id="${reply.id}">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="${reply.retweeted_by_user ? '#00BA7C' : 'currentColor'}" stroke-width="2">
                    <path d="M17 1l4 4-4 4"/>
                    <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                    <path d="M7 23l-4-4 4-4"/>
                    <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                  </svg>
                  <span class="retweet-count">${reply.retweet_count || 0}</span>
                </button>
                <button class="post-action like" onclick="toggleLike('${
                  reply.id
                }', this)" data-liked="${isLiked}" data-tweet-id="${reply.id}">
                  <svg class="icon" viewBox="0 0 24 24" fill="${heartFill}" stroke="${heartStroke}" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                  </svg>
                  <span class="like-count">${reply.like_count || 0}</span>
                </button>
              </div>
            </div>
          `;
          })
          .join("");
      };

      const setupReplyComposer = () => {
        if (!currentUser) return;

        const composer = document.getElementById("replyComposer");
        const userAvatar = document.getElementById("userAvatar");
        const userName = document.getElementById("userName");
        const replyText = document.getElementById("replyText");
        const charCount = document.getElementById("charCount");
        const sendReply = document.getElementById("sendReply");
        const replyStatus = document.getElementById("replyStatus");

        composer.style.display = "block";
        userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
        userName.textContent = currentUser.username;

        replyText.addEventListener("input", () => {
          const length = replyText.value.length;
          charCount.textContent = `${length} / 400`;

          if (length > 400) {
            charCount.classList.add("over-limit");
            sendReply.disabled = true;
          } else {
            charCount.classList.remove("over-limit");
            sendReply.disabled = length === 0;
          }
        });

        sendReply.addEventListener("click", async () => {
          const content = replyText.value.trim();
          if (!content) return;

          sendReply.disabled = true;
          sendReply.textContent = "Replying...";
          replyStatus.style.display = "none";

          try {
            const response = await fetch("/api/tweets", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${authToken}`,
              },
              body: JSON.stringify({
                content,
                reply_to: currentTweet.post.id,
              }),
            });

            const data = await response.json();

            if (data.success) {
              showReplyStatus("Reply sent successfully!", "success");
              replyText.value = "";
              charCount.textContent = "0 / 400";

              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              showReplyStatus(data.error || "Failed to send reply", "error");
            }
          } catch (error) {
            showReplyStatus("Failed to send reply: " + error.message, "error");
          } finally {
            sendReply.disabled = replyText.value.trim().length === 0;
            sendReply.textContent = "Reply";
          }
        });
      };

      const startReply = (postId, username) => {
        if (!currentUser) {
          window.location.href = "/account";
          return;
        }

        const replyingTo = document.getElementById("replyingTo");
        const replyText = document.getElementById("replyText");

        replyingTo.textContent = `@${username}`;
        replyText.focus();
        replyText.scrollIntoView({ behavior: "smooth" });
      };

      const showReplyStatus = (message, type) => {
        const status = document.getElementById("replyStatus");
        status.textContent = message;
        status.className = `status ${type}`;
        status.style.display = "block";

        if (type === "success") {
          setTimeout(() => {
            status.style.display = "none";
          }, 3000);
        }
      };

      const showError = (message) => {
        document.getElementById(
          "errorContainer"
        ).innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
      };

      const formatDate = (dateString) => {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return "now";
        if (minutes < 60) return `${minutes}m`;
        if (hours < 24) return `${hours}h`;
        if (days < 7) return `${days}d`;
        return date.toLocaleDateString();
      };

      const escapeHtml = (text) => {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      };

      const goBack = () => {
        if (window.history.length > 1) {
          window.history.back();
        } else {
          window.location.href = "/";
        }
      };

      const toggleLike = async (tweetId, buttonElement) => {
        if (!authToken) {
          window.location.href = "/account";
          return;
        }

        const isLiked = buttonElement.dataset.liked === "true";

        try {
          const method = isLiked ? "DELETE" : "POST";
          const response = await fetch(`/api/tweets/${tweetId}/like`, {
            method,
            headers: { Authorization: `Bearer ${authToken}` },
          });

          const result = await response.json();

          if (result.success) {
            // Update button state
            const newIsLiked = !isLiked;
            buttonElement.dataset.liked = newIsLiked;

            // Update visual state
            const svg = buttonElement.querySelector("svg");
            const likeCountSpan = buttonElement.querySelector(".like-count");
            const currentCount = parseInt(likeCountSpan.textContent);

            if (newIsLiked) {
              svg.setAttribute("fill", "red");
              svg.setAttribute("stroke", "red");
              likeCountSpan.textContent = currentCount + 1;
            } else {
              svg.setAttribute("fill", "none");
              svg.setAttribute("stroke", "currentColor");
              likeCountSpan.textContent = Math.max(0, currentCount - 1);
            }
          } else {
            console.error("Failed to toggle like:", result.error);
          }
        } catch (error) {
          console.error("Error toggling like:", error);
        }
      };

      const toggleRetweet = async (tweetId, buttonElement) => {
        if (!authToken) {
          window.location.href = "/account";
          return;
        }

        const isRetweeted = buttonElement.dataset.retweeted === "true";

        try {
          const response = await fetch(`/api/tweets/${tweetId}/retweet`, {
            method: "POST",
            headers: { Authorization: `Bearer ${authToken}` },
          });

          const result = await response.json();

          if (result.success) {
            // Update button state
            const newIsRetweeted = result.retweeted;
            buttonElement.dataset.retweeted = newIsRetweeted;

            // Update visual state
            const svg = buttonElement.querySelector("svg");
            const retweetCountSpan = buttonElement.querySelector(".retweet-count");
            const currentCount = parseInt(retweetCountSpan.textContent);

            if (newIsRetweeted) {
              svg.setAttribute("stroke", "#00BA7C");
              retweetCountSpan.textContent = currentCount + 1;
            } else {
              svg.setAttribute("stroke", "currentColor");
              retweetCountSpan.textContent = Math.max(0, currentCount - 1);
            }
          } else {
            console.error("Failed to toggle retweet:", result.error);
          }
        } catch (error) {
          console.error("Error toggling retweet:", error);
        }
      };

      loadCurrentUser();
      loadTweet();
    </script>
  </body>
</html>
