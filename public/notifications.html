<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notifications - tweetapus</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=TikTok+Sans:opsz,wght@12..36,300..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/public/timeline/styles.css" />
    <link rel="stylesheet" href="/public/shared/base.css" />
    <style>
      .notifications-page {
        max-width: 560px;
        margin: 4em auto;
        padding: 0 24px;
        min-height: 100vh;
      }

      .notifications-header {
        margin-bottom: 20px;
        padding: 20px 0;
        border-bottom: 1px solid var(--border-primary);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .notifications-header h1 {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
      }

      .mark-all-read-btn {
        background: none;
        border: none;
        color: var(--accent-primary);
        font-size: 14px;
        font-weight: 500;
        font-family: inherit;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 16px;
        transition: background-color 0.2s ease;
      }

      .mark-all-read-btn:hover {
        background-color: rgba(29, 155, 240, 0.1);
      }

      .notification-loading,
      .no-notifications {
        padding: 40px 16px;
        text-align: center;
        color: var(--text-secondary);
        font-size: 15px;
      }

      .notification-item {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-primary);
        display: flex;
        gap: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        background-color: var(--bg-primary);
        border-radius: 8px;
        margin-bottom: 8px;
      }

      .notification-item:hover {
        background-color: var(--bg-secondary);
        transform: translateX(2px);
      }

      .notification-item.unread {
        background-color: rgba(29, 155, 240, 0.05);
        border-left: 3px solid var(--accent-primary);
        padding-left: 17px;
      }

      .notification-item.unread:hover {
        background-color: rgba(29, 155, 240, 0.1);
      }

      .notification-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-top: 2px;
      }

      .notification-icon.like-icon {
        background-color: rgba(249, 24, 128, 0.1);
        color: #f91880;
      }

      .notification-icon.retweet-icon {
        background-color: rgba(0, 186, 124, 0.1);
        color: #00ba7c;
      }

      .notification-icon.reply-icon {
        background-color: rgba(29, 155, 240, 0.1);
        color: #1d9bf0;
      }

      .notification-icon.follow-icon {
        background-color: rgba(29, 155, 240, 0.1);
        color: #1d9bf0;
      }

      .notification-icon.quote-icon {
        background-color: rgba(0, 186, 124, 0.1);
        color: #00ba7c;
      }

      .notification-icon.mention-icon {
        background-color: rgba(29, 155, 240, 0.1);
        color: #1d9bf0;
      }

      .notification-icon svg {
        width: 16px;
        height: 16px;
      }

      .notification-content {
        flex: 1;
        min-width: 0;
      }

      .notification-content p {
        color: var(--text-primary);
        font-size: 14px;
        line-height: 1.4;
        margin: 0 0 4px 0;
        word-wrap: break-word;
        font-weight: 500;
      }

      .notification-time {
        color: var(--text-secondary);
        font-size: 12px;
        font-weight: 400;
      }

      @media (max-width: 688px) {
        .notifications-page {
          margin: 3em auto;
          padding: 0 16px;
        }

        .notifications-header {
          padding: 16px 0;
        }

        .notifications-header h1 {
          font-size: 20px;
        }

        .notification-item {
          padding: 12px 16px;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="/" class="notifications-btn">
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" />
          <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" />
        </svg>
      </a>
      <button class="account">
        <img src="" alt="User avatar" id="user-avatar" />
        <svg
          width="18"
          height="18"
          viewBox="0 0 18 18"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M4.5 6.75L9 11.25L13.5 6.75"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </button>
      <div class="background">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
    </nav>

    <div class="notifications-page">
      <div class="notifications-header">
        <h1>Notifications</h1>
        <button class="mark-all-read-btn" id="markAllReadBtnPage">
          Mark all as read
        </button>
      </div>

      <div class="notifications-list" id="notificationsPageList">
        <div class="notification-loading">Loading notifications...</div>
      </div>
    </div>

    <script src="/public/shared/darkmode.js" defer></script>
    <script type="module">
      const authToken = localStorage.getItem("authToken");

      class NotificationPageManager {
        constructor() {
          this.notifications = [];
          this.init();
        }

        init() {
          this.bindEvents();
          this.loadNotifications();
          this.loadUserAvatar();
        }

        async loadUserAvatar() {
          if (!authToken) return;

          try {
            const response = await fetch("/api/profile/me", {
              headers: { Authorization: `Bearer ${authToken}` },
            });

            if (response.ok) {
              const data = await response.json();
              const avatarImg = document.getElementById("user-avatar");
              if (avatarImg && data.profile?.avatar) {
                avatarImg.src = data.profile.avatar;
              }
            }
          } catch (error) {
            console.error("Failed to load user avatar:", error);
          }
        }

        bindEvents() {
          const markAllReadBtn = document.getElementById("markAllReadBtnPage");
          markAllReadBtn?.addEventListener("click", () => {
            this.markAllAsRead();
          });
        }

        async loadNotifications() {
          if (!authToken) {
            window.location.href = "/";
            return;
          }

          const listElement = document.getElementById("notificationsPageList");
          if (listElement) {
            listElement.innerHTML =
              '<div class="notification-loading">Loading notifications...</div>';
          }

          try {
            const response = await fetch("/api/notifications/", {
              headers: { Authorization: `Bearer ${authToken}` },
            });

            if (response.ok) {
              const data = await response.json();
              this.notifications = data.notifications || [];
              this.renderNotifications();
            } else {
              console.error("Failed to load notifications:", response.status);
              if (listElement) {
                listElement.innerHTML =
                  '<div class="no-notifications">Failed to load notifications</div>';
              }
            }
          } catch (error) {
            console.error("Failed to load notifications:", error);
            if (listElement) {
              listElement.innerHTML =
                '<div class="no-notifications">Failed to load notifications</div>';
            }
          }
        }

        renderNotifications() {
          const listElement = document.getElementById("notificationsPageList");
          if (!listElement) return;

          if (this.notifications.length === 0) {
            listElement.innerHTML =
              '<div class="no-notifications">No notifications for now!</div>';
            return;
          }

          listElement.innerHTML = this.notifications
            .map((notification) => this.createNotificationHTML(notification))
            .join("");

          listElement.querySelectorAll(".notification-item").forEach((item) => {
            item.addEventListener("click", (e) => {
              const notificationId = e.currentTarget.dataset.id;
              const notificationType = e.currentTarget.dataset.type;
              const relatedId = e.currentTarget.dataset.relatedId;

              this.handleNotificationClick(
                notificationId,
                notificationType,
                relatedId
              );
            });
          });
        }

        async handleNotificationClick(notificationId, type, relatedId) {
          await this.markAsRead(notificationId);

          if (!relatedId) return;

          if (
            type === "like" ||
            type === "retweet" ||
            type === "reply" ||
            type === "quote" ||
            type === "mention"
          ) {
            try {
              const response = await fetch(`/api/tweets/${relatedId}`, {
                headers: authToken
                  ? { Authorization: `Bearer ${authToken}` }
                  : {},
              });

              if (response.ok) {
                window.location.href = `/tweet/${relatedId}`;
              } else {
                console.error("Tweet not found");
              }
            } catch (error) {
              console.error("Failed to load tweet:", error);
            }
          } else if (type === "follow") {
            try {
              const response = await fetch(`/api/profile/${relatedId}`, {
                headers: { Authorization: `Bearer ${authToken}` },
              });

              if (response.ok) {
                window.location.href = `/@${relatedId}`;
              } else {
                console.error("Profile not found");
              }
            } catch (error) {
              console.error("Failed to load profile:", error);
            }
          }
        }

        createNotificationHTML(notification) {
          const timeAgo = this.getTimeAgo(new Date(notification.created_at));
          const isUnread = !notification.read;
          const icon = this.getNotificationIcon(notification.type);
          const iconClass = this.getNotificationIconClass(notification.type);

          return `
            <div class="notification-item ${
              isUnread ? "unread" : ""
            }" data-id="${notification.id}" data-type="${
            notification.type
          }" data-related-id="${notification.related_id || ""}">
              <div class="notification-icon ${iconClass}">
                ${icon}
              </div>
              <div class="notification-content">
                <p>${notification.content}</p>
                <span class="notification-time">${timeAgo}</span>
              </div>
            </div>
          `;
        }

        getNotificationIconClass(type) {
          const classes = {
            like: "like-icon",
            retweet: "retweet-icon",
            reply: "reply-icon",
            follow: "follow-icon",
            quote: "quote-icon",
            mention: "mention-icon",
          };
          return classes[type] || "follow-icon";
        }

        getNotificationIcon(type) {
          const icons = {
            like: `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>`,
            retweet: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 1l4 4-4 4"/>
              <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
              <path d="M7 23l-4-4 4-4"/>
              <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
            </svg>`,
            reply: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>`,
            follow: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>`,
            quote: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/>
              <path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z"/>
            </svg>`,
            mention: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M19 8v6"/>
              <path d="M22 11h-6"/>
            </svg>`,
          };
          return icons[type] || icons.like;
        }

        getTimeAgo(date) {
          const now = new Date();
          const diffInSeconds = Math.floor((now - date) / 1000);

          if (diffInSeconds < 60) return "just now";
          if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m`;
          if (diffInSeconds < 86400)
            return `${Math.floor(diffInSeconds / 3600)}h`;
          if (diffInSeconds < 604800)
            return `${Math.floor(diffInSeconds / 86400)}d`;
          return date.toLocaleDateString();
        }

        async markAsRead(notificationId) {
          if (!authToken) return;

          try {
            const response = await fetch(
              `/api/notifications/${notificationId}/read`,
              {
                method: "PATCH",
                headers: { Authorization: `Bearer ${authToken}` },
              }
            );

            if (response.ok) {
              const notification = this.notifications.find(
                (n) => n.id === notificationId
              );
              if (notification) {
                notification.read = true;
                this.renderNotifications();
              }
            }
          } catch (error) {
            console.error("Failed to mark notification as read:", error);
          }
        }

        async markAllAsRead() {
          if (!authToken) return;

          try {
            const response = await fetch("/api/notifications/mark-all-read", {
              method: "PATCH",
              headers: { Authorization: `Bearer ${authToken}` },
            });

            if (response.ok) {
              this.notifications.forEach((notification) => {
                notification.read = true;
              });
              this.renderNotifications();
            }
          } catch (error) {
            console.error("Failed to mark all notifications as read:", error);
          }
        }
      }

      new NotificationPageManager();
    </script>
  </body>
</html>
